name: Build and push test suite images

on:
  workflow_dispatch:
    inputs:
      release_branch:
        description: Branch to release
        default: master
        type: string
        required: true
      quay_org:
        description: Quay organization
        type: string
        default: kiali
        required: true
      images_tag:
        description: Images tag
        type: string
        default: dev
        required: true
  workflow_call:
    inputs:
      release_branch:
        description: Branch to release
        type: string
        required: true
      quay_org:
        description: Quay organization
        type: string
        required: true
      images_tag:
        description: Images tag
        type: string
        required: true
    secrets:
      QUAY_USER:
        description: 'A quay user secret passed from the caller workflow'
        required: true
      QUAY_PASSWORD:
        description: 'A quay user password passed from the caller workflow'
        required: true


jobs:
  build_and_push_cypress_tests:
    name: Generate and push ossmc cypress test docker images
    runs-on: ubuntu-latest
    env:
      # These ENVs are expected in Make file!
      IMAGE_ORG: ${{ inputs.quay_org }}
      CYPRESS_TESTS_CONTAINER_VERSION: ${{ inputs.images_tag }}
    steps:
    - name: Log information
      run: |
        echo "Branch": ${{ inputs.release_branch }}
        echo "Quay organization": ${{ inputs.quay_org }}
        echo "Images tag": ${{ inputs.images_tag }}
    - name: Checkout code
      uses: actions/checkout@v5
      with:
        ref: ${{ inputs.release_branch }}
    - name: Login to Quay.io
      uses: docker/login-action@v3
      with:
        registry: quay.io
        username: ${{ secrets.QUAY_USER }}
        password: ${{ secrets.QUAY_PASSWORD }}
    - name: "Build cypress test image"
      run: |
        make container-build-cypress-tests container-push-cypress-tests-quay
